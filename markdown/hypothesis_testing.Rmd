---
title: "Hypothesis Testing"
author: "BIOSCI220"
date: "Semester 1 2020"
output:
  html_document:
    toc: true
    toc_depth: 2
    highlight: tango
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE,message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(magick)
library(gganimate)
```

## Learing Objectives

By the end of this lab students should be able to

   + List appropriate questions posed by the biological questions and outline an appropriate hypothesis test that would answer it
   + Describe the aims of the following hypothesis tests
      + one-sample t-test
      + two-sample t-test (independent and dependent)
      + randomization test
      + one-way Analysis of Variance (ANOVA)
  + List the aims of hypothesis testing and write out the appropriate null and alternative hypothesis using statistical notation
  + Write R code to carry out an hypothesis test using the appropriate variables in their dataset. Specifically write R code to carry out
     + one-sample t-test
     + two-sample t-test (independent and dependent)
     + randomization test
     + one-way Analysis of Variance (ANOVA)
  + Interpret and communicate the findings of an hypothesis test accurately and concisely
  + List the limitations of the hypothesis in relation to the questions posed by the data

## Suggested reading

## Motivation

### Toss a coin 10 times.

<img src="../gifs/binomial_cat.gif" />

## Comparing differences in mean scores

### Am I being ripped off by the dog food company?

Hypothesis: On average each bag contains 5kg of dog food.

```{r one-sample}
## simulate data
dog <- data.frame(type = "Food",weight = rnorm(100,5,1), reps = rep(1:10,each = 10))

means_df <- dog %>%
    group_by(reps,type) %>%
    summarize(means = mean(weight),
              sem = sd(weight)/sqrt(length(weight)))

stats_df <- dog %>%
    group_by(reps) %>%
    summarize(ts = t.test(weight,mu = 5)$statistic)


a <- ggplot(means_df, aes(x = type, y = means)) +
    geom_bar(stat = "identity") +
    geom_point(aes(x = type, y = weight), data = dog, alpha = .25) +
    geom_errorbar(aes(ymin = means - sem, ymax = means + sem), width = .2) +
    theme(axis.title.x=element_blank(),
          axis.ticks.x=element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
    geom_hline(yintercept = 5, col = "red") + 
    xlab("") + ylab("Weight of dog food (kg)") +
    transition_states(
        states = reps,
        transition_length = 2,
        state_length = 1) +
    geom_text(aes(0.5, 7.5,label = paste("Sample mean:", format(round(means, 3),nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    enter_fade() + 
    exit_shrink() +
    ease_aes('sine-in-out')
  
a_gif <- animate(a, width = 420, height = 420)

b <- ggplot(stats_df, aes(x = ts))+
  geom_vline(aes(xintercept = ts, frame = reps))+
  geom_line(aes(x=x,y=y),
            data = data.frame(x = seq(-5,5, .1),
                              y = dt(seq(-5,5, .1), df = 18))) +
    theme(panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
  ylab("density") +
  xlab("t-statistic") +
  transition_states(
    states = reps,
    transition_length = 2,
    state_length = 1
  ) +
    geom_text(aes(-4, 0.5,label = paste("t-statistic:", format(round(ts, 3), nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')

b_gif <- animate(b, width = 420, height = 420)

a_mgif <- image_read(a_gif)
b_mgif <- image_read(b_gif)

new_gif <- image_append(c(a_mgif[1], b_mgif[1]))
for(i in 2:100){
  combined <- image_append(c(a_mgif[i], b_mgif[i]))
  new_gif <- c(new_gif, combined)
}

new_gif


```



### Do medics study harder than biologists


```{r independent t-test}
## independant t-test
## simulate data
A <-rnorm(100,50,10)
B <-rnorm(100,45,10)
DV <- c(A,B)
Student <- rep(c("Medics","Biologists"),each=100)
sims <- rep(rep(1:10,each=10),2)
df <- data.frame(sims, Student, DV)

means_df <- df %>%
               group_by(sims,Student) %>%
               summarize(means=mean(DV),
                         sem = sd(DV)/sqrt(length(DV)))
means_df$lab <- rep(1:2, times = 10)

stats_df <- df %>%
              group_by(sims) %>%
              summarize(ts = t.test(DV~Student,var.equal=TRUE)$statistic)

a <- ggplot(means_df, aes(x=Student,y=means, fill=Student))+
    geom_bar(stat="identity")+
    geom_point(data=df,aes(x=Student, y=DV), alpha=.25)+
    geom_errorbar(aes(ymin=means-sem, ymax=means+sem),width=.2) +
    ylab("Number of hours studied") +
    theme(axis.title.x=element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
    transition_states(
        states = sims,
        transition_length = 2,
        state_length = 1
    ) +
    geom_text(aes(0.5, 80,label = paste("Sample mean Biologists:",
                                        format(round(means[c(sims[c(TRUE,TRUE,FALSE,FALSE)],
                                                             means_df$sims[c(TRUE,TRUE,FALSE,FALSE)] + 10)], 3),
                                               nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    geom_text(aes(0.5, 76,label = paste("Sample mean Medics:", format(round(means[sims*2], 3),
                                                                      nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    enter_fade() + 
    exit_shrink() +
    ease_aes('sine-in-out')

a_gif <- animate(a, width = 420, height = 420)

b <- ggplot(stats_df,aes(x=ts))+
    geom_vline(aes(xintercept=ts, frame=sims))+
    geom_line(data=data.frame(x=seq(-5,5,.1),
                              y=dt(seq(-5,5,.1),df=18)),
              aes(x=x,y=y)) +
    theme(panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
    ylab("density")+
    xlab("t-statistic")+
    transition_states(
        states=sims,
        transition_length = 2,
        state_length = 1
    ) +
    geom_text(aes(-4, 0.5,label = paste("t-statistic:", format(round(ts, 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    enter_fade() + 
    exit_shrink() +
    ease_aes('sine-in-out')

b_gif<-animate(b, width = 420, height = 420)


d<-image_blank(420*2,420)

the_frame<-d
for(i in 2:100){
  the_frame<-c(the_frame,d)
}

a_mgif<-image_read(a_gif)
b_mgif<-image_read(b_gif)

new_gif<-image_append(c(a_mgif[1], b_mgif[1]))
for(i in 2:100){
  combined <- image_append(c(a_mgif[i], b_mgif[i]))
  new_gif<-c(new_gif,combined)
}

new_gif


```



All the tests in the t-test family compare differences in mean scores of continuous, normally distributed, data


## How do I get to work the quickest? One way ANOVA

```{r anova gif,fig.cap= "Plot modified from [https://crumplab.github.io/statistics/gifs.html](https://crumplab.github.io/statistics/gifs.html)"}
A <- rnorm(100,45,10)
B <- rnorm(100,50,10)
C <- rnorm(100,40,10)
DV <- c(A,B,C)
Transport <- rep(rep(c("Car","Bus","Train"),each=10),10)
sims <- rep(1:10,each=30)
df<-data.frame(sims,Transport,DV)

means_df <- df %>%
  group_by(sims,Transport) %>%
  summarize(means=mean(DV),
            sem = sd(DV)/sqrt(length(DV)))

stats_df <- df %>%
  group_by(sims) %>%
  summarize(Fs = summary(aov(DV~Transport))[[1]][[4]][1])

a <- ggplot(means_df, aes(x=Transport,y=means, fill=Transport)) +
    geom_bar(stat="identity") +
    geom_point(data=df,aes(x=Transport, y=DV), alpha=.25) +
    geom_errorbar(aes(ymin=means-sem, ymax=means+sem),width=.2)  +
    theme(axis.title.x=element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) + ylab("Time to work (mins)") +
    transition_states(
        states=sims,
        transition_length = 2,
        state_length = 1
    ) +
    geom_text(aes(0.5, 78,label = paste("Sample mean Bus:", format(round(means[rep(seq(1,30,3),each = 3)], 3),
                                                                      nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    geom_text(aes(0.5, 74,label = paste("Sample mean Car:", format(round(means[rep(seq(2,30,3),each = 3)], 3),
                                                                      nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    geom_text(aes(0.5, 70,label = paste("Sample mean Train:", format(round(means[sims*3], 3),
                                                                      nsmall = 2))),
              size = 4, hjust = 0, color = "black") + enter_fade() + 
    exit_shrink() +
    ease_aes('sine-in-out')

b <- ggplot(stats_df,aes(x=Fs))+
    geom_vline(aes(xintercept=Fs))+
    ## geom_vline(xintercept=qf(.95, df1=2,df2=27),color="green")+
    geom_line(data=data.frame(x=seq(0,6,.1),
                              y=df(seq(0,6,.1),df1=2,df2=27)),
              aes(x=x,y=y)) +
    theme(panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
    ylab("density")+
    xlab("F-statistic")+
    transition_states(
        states=sims,
        transition_length = 2,
        state_length = 1
    ) + enter_fade() +
    geom_text(aes(4, 1,label = paste("F-statistic:", format(round(Fs, 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    exit_shrink() +
    ease_aes('sine-in-out')

a_gif<-animate(a,width=420,height=420)
b_gif<-animate(b,width=420,height=420)

a_mgif<-image_read(a_gif)
b_mgif<-image_read(b_gif)

new_gif<-image_append(c(a_mgif[1], b_mgif[1]))
for(i in 2:100){
  combined <- image_append(c(a_mgif[i], b_mgif[i]))
  new_gif<-c(new_gif,combined)
}

new_gif


```


## Does study help students pass exams? Randomization test


```{r randomisation gif,fig.cap= "Source [https://crumplab.github.io/statistics/gifs.html](https://crumplab.github.io/statistics/gifs.html)"}
study <- round(runif(10,80,100))
no_study <- round(runif(10,40,90))

study_df<-data.frame(student=seq(1:10),study,no_study)
mean_original<-data.frame(IV=c("studied","did not study"),
                          means=c(mean(study),mean(no_study)))
t_df <- data.frame(sims=rep(1,20),
                 IV=rep(c("studied","did not study"),each=10),
                 values=c(study,no_study),
                 rand_order=rep(c(0,1),each=10))

raw_df<-t_df
for(i in 2:10){
  new_index<-sample(1:20)
  t_df$values<-t_df$values[new_index]
  t_df$rand_order<-t_df$rand_order[new_index]
  t_df$sims<-rep(i,20)
  raw_df<-rbind(raw_df,t_df)
}

raw_df$rand_order<-as.factor(raw_df$rand_order)
rand_df<-aggregate(values~sims*IV,raw_df,mean)
names(rand_df)<-c("sims","IV","means")
rand_df$rand_order <- as.factor(1)


a <- ggplot(data = raw_df,aes(x=IV,y=values,color=rand_order), color = c("red","blue")) +
    geom_point(stat="identity",alpha=.5,size = 6) +
    geom_point(data=mean_original,aes(x = IV,y = means,),
               stat="identity",shape=21,size = 6,color="black",fill="black") +
    geom_point(data=rand_df,aes(x=IV,y=means),stat="identity",
               shape=21,size=6,color="gold",fill="gold") +
    geom_text(data=rand_df,aes(x = IV,y=means,label = "Randomized mean"),stat="identity", color = "black",
              nudge_x = -0.3) +
    coord_cartesian(ylim=c(40, 100)) +
    ylab("Exam grade") +
    scale_color_manual(values = c("red","blue"),
                       labels = c("studied","did not study"),name = "Original data") +
    annotate("text",x = c(1.25,2.25), y = rev(mean_original$means), label = "Original mean") + 
    theme(legend.position="bottom",
          axis.title.x=element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
    transition_states(
        sims,
        transition_length = 1,
        state_length = 2
    ) + enter_fade() +
    exit_shrink() +
    ease_aes('sine-in-out')

animate(a,nframes=100,fps=5)


```





## Application to the mussel dataset