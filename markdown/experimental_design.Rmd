---
title: "Experimental design"
author: "BIOSCI220"
date: "Semester 1 2020"
output:
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    toc_depth: 3
    highlight: espresso
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE,message = FALSE, warning = FALSE,fig.align = "center")
library(animation)
library(emoGG)
library(ggplot2)
```

# Learing Objectives

By the end of this lab student should be able to

   + Identify the following experimental variables
      + independent variable
      + dependent variable
   + Describe the setup of the following experimental designs
       + independent measures (between groups)
       + repeated measures (within groups)
       + randomisation
   + Identify the type of design used in the given case studies
   + Discuss the advantages and disadvantages of different design types
   + Critique experimental designs used in the the given case studies
   + Design an experiment that follows good experimental design principles
   + State in terms of probability statements the meaning of the power and significance level of an hypothesis test


## Suggested reading

[Glass, David J. Experimental Design for Biologists. Second ed. 2014. Print.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21237737730002091&search_scope=Combined_Local&tab=books&vid=NEWUI&context=L)

[Welham, S. J. Statistical Methods in Biology : Design and Analysis of Experiments and Regression. 2015. Print.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21237737830002091&search_scope=Combined_Local&tab=books&vid=NEWUI&context=L)

[Heath, David. An Introduction to Experimental Design and Statistics for Biology. London: UCL, 1995. Print.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21133208810002091&search_scope=Combined_Local&tab=books&vid=NEWUI&context=L)

[Fisher, Ronald Aylmer. The Design of Experiments. 8th ed. Edinburgh: Oliver & Boyd, 1966. Print. O & B Paperbacks.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21198532990002091&context=L&vid=NEWUI&lang=en_US&search_scope=Combined_Local&adaptor=Local%20Search%20Engine&isFrbr=true&tab=books&query=any,contains,The_Design_of_Experiments&sortby=date&facet=frbrgroupid,include,627497507&offset=0)

[Gelman, A. T., \& Loken, E.The garden of forking paths: Why multiple comparisons can be a problem, even when there is no “fishing expedition” or “p-hacking” and the research hypothesis was posited ahead of time.](http://www.stat.columbia.edu/~gelman/research/unpublished/p_hacking.pdf)

# Dependent and independent variables

```{r ivdv}
d <- data.frame(y = rep(3:1,times = c(6,1,3)),x = c(-1,-0.1,0.1, 0.9,1,1.1,0,-1,0,1))
ggplot(d,aes(x = x, y = y)) + geom_emoji(data = d[1:6,],emoji = "1f4a7",size = 0.05) + geom_emoji(data = d[7,],emoji = "1f4cf",size = 0.1) +
  geom_emoji(data = d[8,],emoji = "1f331",size = 0.1) + geom_emoji(data = d[9,],emoji = "1f33f",size = 0.1) +
  geom_emoji(data = d[10,],emoji = "1f333",size = 0.1) + 
  theme_void() + xlim(c(-2,2)) + ylim(c(-1,4)) +  
  annotate("text", x = 0, y = 2.5, label = " The independent variable represents a \n quantity that is being manipulated (e.g., amount of water)") +  
  annotate("text", x = 0, y = 1.5, label = " The dependent variable represents a quantity \n that depends on the intependent variable (e.g., height of plant)")

```

# A simple design: Independent measures (between subjects)

Separate groups are created for each treatment (i.e., each participant is assigned to only one treatment group); participants can only be a member of **one** of the groups

```{r independent,message=FALSE,cache=TRUE,results='hide'}
plot(1:15, rep(1,15),col = rep(1:3,each = 5),pch = 20,axes = FALSE, xlab = "",ylab = "",cex = 4);
legend("topleft",bty = "n",pch = 20, col = 1:3, legend = c("Group 1","Group 2", "Control"))

```

**Advantages**

 + simple design setup
 + multiple treatments can be tested at the same time
 + quick
    
**Disadvantages**

  + each participant is only being tested once
  + complex if more than a few treatments are being tested. Other disadvantages include:
  + differences in individuals may skew results
  + bias can be an issue 
    + control for this by using experimental blinds?
      + single blind, the participant doesn’t know if they are getting a treatment or placebo
      + double blind, where neither the participant nor the researcher know


# Fisher's principles of experimental design


## Replication (repeated measures  or within groups)

**An experiment should be repeated more than once**

We should repeat an experiment to fully assess variability and enable us to (with caution) generalise results. Here, each group member is tested **multiple** times or under **different** conditions.

```{r repeated,message=FALSE,cache=TRUE,results='hide'}
plot(1:15, rep(1.5,15),col = rep(1:3,each = 5),pch = 17,axes = FALSE, xlab = "",ylab = "",cex = 3,ylim = c(0,2.5))
points(1:15,rep(1,15),col = rep(1:3,each = 5),pch = 18,cex = 3)
points(1:15,rep(0.5,15),col = rep(1:3,each = 5),pch = 19, cex = 3)
legend("topleft",bty = "n",pch = 17:19, col = "grey", legend = paste("Treatment", 1:3))
legend("topright",bty = "n",pch = 20, col = 1:3, legend = paste("Patient", 1:3))

```

**Types** 

 + Assigned a single treatment and the results are measured over time 
 + Crossover design: paricipants assigned all treatments, and the results are measured over time 


  **Advantages** 
  
  + fewer patients are needed overall
  + variability between subjects already controled for
    
  **Disadvantages**
  
  + possibility that the position of the treatment in the order of treatments matters
    + randomization or counterbalancing can correct for this.
  + carryover fffects (i.e., one part of the experiment can have trickle down effects to subsequent parts)
  + death or dropout of subjects 


## Randomization

Plan the experiment in such a way that the variations caused by extraneous factors can all be combined under the general heading of “chance.


```{r flip,message=FALSE,cache=TRUE,results='hide'}
pngs <- list.files("../gifs/","coin.png",full = TRUE)
imgs <- lapply(pngs,png::readPNG)
ani.options(interval = 0.5)
dir <- getwd()
setwd("../gifs")
saveGIF(
    for(i in 1:2){
        plot(1,type = "n", axes = FALSE,xlim = c(-0.6,0.6),xlab ="",ylim = c(-0.6,0.6),ylab = "")
        rasterImage(imgs[[i]],-0.5,-0.5,0.5,0.5)
    },movie.name = "flip.gif"
)
setwd(dir)
```

![](../gifs/flip.gif)


Evenly distributes any variability in outcome due to outside factors across treatment groups. 

Example: double-blind medical trials, neither patient nor doctor knows which group has been assigned, group assignment is made randomly by 3rd party


## Local Control

Balancing, blocking and grouping of the experimental units

### Randomised block design 


Blocking helps control variability by making treatment groups more alike
Inside of groups, differences will be minimal. Across groups, differences will be
larger. In randomised block design, the researcher divides experimental subjects into homogeneous blocks. Treatments are then randomly assigned to the blocks. The variability within blocks should be greater than the variability between blocks. In other words, you need to make sure that the blocks contain subjects that are very similar. For example, you could put males in one block and females in a second block. 


```{r random block,echo = FALSE}
block <- rep(1:4, each = 4)
set.seed(4321)
treatment <- c(replicate(4,sample(1:4,size = 4)))
plot(1:16,rep(1,length(block)),col = block,pch = treatment + 14,axes = FALSE,xlab = "",ylab = "",cex = 3)
legend("topright",bty = "n", pch = 15:18, legend = paste("Treatment",1:4), col = "grey")
legend("topleft",bty = "n", pch = 20, col = 1:4, legend = paste("Block",1:4))

```

#### Matched pairs design

Matched pairs design is a special case of randomized block design. In this design, two treatments are assigned to homogeneous groups (blocks) of subjects. The goal is to maximize homogeneity in each pair. In other words, you want the pairs to be as similar as possible. The blocks are composed of matched pairs which are randomly assigned a treatment (commonly the drug or a placebo).

For example, an experiment to test a new drug may have blocks of 200 males and 200 females. Each block contains 100 pairs, who are matched according to some criteria other than sex (like age, other medications, or health conditions). Each pair is then treated like a block, with each randomly assigned to receive the drug or a placebo. 

### Randomised controlled design 

A randomized controlled trial is an experiment where the participants are randomly allocated to two or more groups to test a specific treatment or drug. Participants are assigned to either an experimental group or a comparison group. Random allocation means that all participants have the same chance of being placed in either group. 


```{r random_controlled,message=FALSE,results='hide'}
ani.options(interval = 1)
dir <- getwd()
setwd("../gifs")
saveGIF(
for(i in 1:10){
  plot(1:10, rep(1,10),col = 1,pch = 20,axes = FALSE, xlab = "",ylab = "",cex = 4)
  legend("topleft",bty = "n",pch = 20, col = 1, legend = "Patients")
  legend("topright",bty = "n",pch = 20, col = 1:2, legend = c("Experimental group", "Comparison group"))
  treatment <- sample(1:2,replace = TRUE, size = 10)
  plot(1:10, rep(1,10),col = treatment,pch = 20,axes = FALSE, xlab = "",ylab = "",cex = 4);
  legend("topleft",bty = "n",pch = 20, col = 1, legend = "Patients")
  legend("topright",bty = "n",pch = 20, col = 1:2, legend = c("Experimental group", "Comparison group"))
},movie.name = "rcontrolled.gif")
setwd(dir)
```

![](../gifs/rcontrolled.gif)


**Advantages**

  + Random allocation can cancel out population bias; it ensures that any other possible causes for the experimental results are split equally between groups.

  + Blinding is easy to include in this type of experiment.

  + Results from the experiment can be analyzed with statistical tests and used to infer other possibilities, like the likelihood of the method working for all populations.

  + Participants are readily identifiable as members of a specific population.

**Disadvantages**

  + Generally more expensive and more time consuming than other methods.

  + Very large sample sizes often needed.

  + Random controlled trials cannot uncover causation/risk factors. For example, ethical concerns would prevent a randomized controlled trial investigating the risk factors for smoking.

  + This type of experimental design is unsuitable for outcomes which take a long time to develop. Cohort studies may be a more suitable alternative.

  + Some programs, for example cancer screening, are unsuited for random allocation of participants (again, due to ethical concerns).

  + Volunteer bias can be an issue.



# Power and significance level

  + Power: probability that the test correctly rejects the null hypothesis when the
alternative hypothesis is true. probability of finding an effect that is there =  1 - probability of a Type II error (False negative)
  + Effect size: standardized measure of the difference you're trying to detect 
  + Sample Size: How many experimental units you need to survey to detect the
desired difference at the desired power 
  + Significance level = probability of a Type I error = probability of finding an effect that is not there (False positive)

```{r power}

```

# Quizzes

### Practise quiz (not examinable)


### Pre lab quiz available here (worth 1\% of final grade)


# Lab work 

### Get into groups of 4--6 and...

...discuss [this article on p-hacking](http://www.stat.columbia.edu/~gelman/research/unpublished/p_hacking.pdf). Talk about the flaws in the statistical analysis and/or experimental design in each of the critiqued papers. Use this form to record your answers/thoughts.



## Design your own experiment (worth 6\% of your final grade)

In groups you give yourselves half an hour to design and carry out your own experiment. Then each group should pair up with another group and present their design, results, and flaws **as a group** for 5mins. In this excersise you will be peer reviewed so in your pairs of groups you **must** fill out this form.