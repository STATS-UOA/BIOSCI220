---
title: "Hypothesis testing"
author: ""
date: ""
output: ioslides_presentation
---

<style type="text/css">
slides > slide:not(.nobackground):after {
  content: '';
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE,message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(magick)
library(gganimate)
library(patchwork)
```

## Hypothesis testing

<ul style="font-family: bookman, bookman; font-size:20pt; top:35%;position: absolute;">
<li> Hypothesis \& assumptions</li>
<li> Test statistic</li>
<li> What is the probability of observing that test statistic? (p-value)</li>
</ul>

## Inference about a mean

![](../gifs/os_ttest.gif)

## Inference about two means

![](../gifs/ts_ttest.gif)

## The P$\overline{\text{a}}$ua dataset

<p style="font-family: bookman, bookman; font-size:20pt"> The P$\overline{\text{a}}$ua dataset contains the following variables</p>
<ul style="font-family: bookman, bookman; font-size:20pt; top:35%;position: absolute;">
<li> Age of  P$\overline{\text{a}}$ua in years (calculated from counting rings in the
cone) </li>
<li> Length of  P$\overline{\text{a}}$ua shell in centimeters</li>
<li> Species of  P$\overline{\text{a}}$ua: *Haliotis iris* (typically found in NZ) and
*Haliotis australis* (less commonly found in NZ) </li>

</ul>

## The P$\overline{\text{a}}$ua dataset

```{r head,echo = 2}
paua <- read.csv("../data/paua.csv")
head(paua)
```

## Inference about two means

Null hypothesis: $H_0$ (that each species has on average the same length of shell) verses the alternative hypothesis, $H_1$, that they don't!

+ $H_0: \mu_{\text{Haliotis iris}} - \mu_{\text{Haliotis australis}} = 0$ vs $H_1: \mu_{\text{Haliotis iris}} \neq \mu_{\text{Haliotis australis}}$

Assumptions: 

  + Each P$\overline{\text{a}}$ua is independent of the other
  + Each datapoint (length, cm) come from the same distribution
  + The length of shells are Normally distributed
  
## Inference about two means
  
```{r bar plot,echo = FALSE, eval = TRUE}

means_df <- paua %>%
    group_by(Species) %>%
    summarize(means=mean(Length),
              sem = sd(Length)/sqrt(length(Length)))

a <- ggplot(means_df, aes(x = Species, y = means,fill = Species)) +
    geom_bar(stat = "identity") + scale_fill_brewer(palette = "Dark2") +
    geom_point(aes(x = Species, y = Length), data = paua, alpha = .25) +
    geom_errorbar(aes(ymin = means - sem, ymax = means + sem), width = .2) +
    theme(axis.title.x=element_blank(),
          axis.ticks.x=element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          legend.position = "none",
          panel.border = element_rect(colour='black', fill=NA)) +
    geom_text(aes(0.4, 7,label = paste("Sample mean australis:", format(round(means_df[[1,2]], 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    geom_text(aes(0.4, 6.5,label = paste("Sample mean iris:", format(round(means_df[[2,2]], 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") 

a

```
  
## Same length on average?

Using R

```{r simple,echo = TRUE, eval = TRUE}
t.test <- t.test(paua$Length~paua$Species,var.equal = FALSE)
t.test
```

## As a plot

```{r t-test plot,echo = FALSE, eval = TRUE}

stats_df <- paua %>%
    summarize(ts = t.test(Length~Species,var.equal=FALSE)$statistic)

a <- ggplot(means_df, aes(x = Species, y = means,fill = Species)) +
    geom_bar(stat = "identity") + scale_fill_brewer(palette = "Dark2") +
    geom_point(aes(x = Species, y = Length), data = paua, alpha = .25) +
    geom_errorbar(aes(ymin = means - sem, ymax = means + sem), width = .2) +
    theme(axis.title.x=element_blank(),
          axis.ticks.x=element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA),
          legend.position = "none") +
    geom_text(aes(0.4, 7,label = paste("Sample mean australis:", format(round(means_df[[1,2]], 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    geom_text(aes(0.4, 6.5,label = paste("Sample mean iris:", format(round(means_df[[2,2]], 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") 

## for p-value shading
crit_df <- data.frame(ts = seq(3.5,5,length.out = 100))
crit_df$y <- dt(crit_df$ts,df = 57) ## corresponding t vals

b <- ggplot(stats_df,aes(x=ts))+
    geom_vline(aes(xintercept=ts))+
    geom_line(data=data.frame(x=seq(-5,5,.1),
                              y=dt(seq(-5,5,.1),df=57)),
              aes(x=x,y=y)) +
    theme(panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour='black', fill=NA)) +
    ylab("density") +
    xlab("t-statistic") +
    geom_line(data = crit_df, aes(x = ts,y = y), col = "grey") +
    geom_line(data = crit_df, aes(x = -ts,y = y), col = "grey") +
    geom_text(aes(-4, 0.5,label = paste("t-statistic:", format(round(ts, 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black") +
    geom_text(aes(-4, 0.475,label = paste("p-value:", format(round(2*pt(abs(ts),df = 57,lower.tail = FALSE), 2),
                                                             nsmall = 2))),
              size = 4, hjust = 0, color = "grey")

a + b
```

## Power and significance

**Type I** error (false positive): declare a difference (i.e., reject $H_0$) when there is no difference (i.e. $H_0$ is true). Risk of the Type I error is determined by the *level of significance* (which we set!) (i.e., $\alpha =\text{ P(Type I error)} = \text{P(false positive)}$.

**Type II** error (false negative): difference not declared (i.e., $H_0$ not rejected) when there is a difference (i.e., $H_0$ is false). Let $\beta =$ P(do not reject $H_0$ when $H_0$ is false); so, $1-\beta$ = P(reject $H_0$ when $H_0$ is false) = P(a true positive), which is the statistical **power** of the test.

## Multiple comparisons

**Each** time we carry out a hypothesis test the probability we get a false positive result (type I error) is given by $\alpha$ (the *level of significance* we choose).

When we have **multiple comparisons** to make we should then control the **Type I** error rate across the entire *family* of tests under consideration, i.e., control the Family-Wise Error Rate (FWER); this ensures that the risk of making at least one **Type I** error among the family of comparisons in the experiment is $\alpha$.

## One way ANOVA

![](../gifs/anova.gif)

## Key assumptions of ANOVA

Observations are independent

All observations have the same variance (e.g., spread of the observations does not depend on the Treatment mean)

All observations are (approximately) normally distributed.
 
## ANOVA

F-statistic = ${\frac  {{\text{explained variance}}}{{\text{unexplained variance}}}} = {\frac  {{\text{between-group variability}}}{{\text{within-group variability}}}}$ 

```{r anova-bw}
A <- rnorm(100,8,1)
B <- rnorm(100,9.5,1)
C <- rnorm(100,7,1)
data <- data.frame(y = c(A,B,C),x = rep(c("A","B","C"),each = 100))

a <- ggplot(data, aes(x = x, y = y, fill = x)) + geom_boxplot() +
  theme(axis.title = element_blank(),
        legend.position = "none") + ylim(range(data$y))

A2 <- rnorm(100,8,0.8)
B2 <- rnorm(100,9.5,3)
C2 <- rnorm(100,7,0.1)
data2 <- data.frame(y = c(A2,B2,C2),x = rep(c("A","B","C"),each = 100))

b <- ggplot(data2, aes(x = x, y = y, fill = x)) + geom_boxplot() +
  theme(axis.title = element_blank(),
        legend.position = "none") + ylim(range(data$y))

a + b

```

## Randomization test. 

![](../gifs/random.gif)


## Next Time Linear Modelling

![](../gifs/lm.gif)



## 


<ul style="font-family: bookman, bookman; font-size:30pt; top:40%;position: absolute;">
  https://b.socrative.com/login/student/
  Room Name: BIOSCI220
 </ul>

